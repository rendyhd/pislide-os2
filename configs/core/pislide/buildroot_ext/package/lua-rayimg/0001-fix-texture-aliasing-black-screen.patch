From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Wed, 27 Nov 2025 00:00:00 +0000
Subject: [PATCH] fix: Implement early pre-loading strategy and prevent black
 screen bug

This patch implements an early image pre-loading strategy to improve
slideshow performance with large images, and fixes a critical black
screen bug that occurs during image transitions.

Key changes:

1. New preload_next_image() function that:
   - Cleans up existing next_texture before loading new one
   - Uses pcall for error handling to prevent crashes
   - Falls back gracefully on load failures

2. Early preloading at startup to use full display time for loading

3. Graceful transition check - only transitions when next image is ready,
   extends display time if image not loaded yet

4. CRITICAL FIX: Set next_texture = nil after assigning to loaded_texture
   to prevent the cleanup in preload_next_image() from unloading the
   texture that loaded_texture is still displaying (black screen bug)

5. Preloading after manual navigation (left/right keys)

6. Preloading after non-crossfade transitions

---
 rayimg/build/rayimg/main.lua | 57 +++++++++++++++++++++++++++---------
 1 file changed, 43 insertions(+), 14 deletions(-)

diff --git a/rayimg/build/rayimg/main.lua b/rayimg/build/rayimg/main.lua
--- a/rayimg/build/rayimg/main.lua
+++ b/rayimg/build/rayimg/main.lua
@@ -61,11 +61,6 @@
 local loaded_texture = image_handler:get_current_image()
 local next_texture

-
-if args.transition_duration > 0 then
-   next_texture = image_handler:peek_next_image()
-end
-
 local timer_duration = 0
 local transitioning = false
 local transition_time = 0
@@ -77,6 +72,29 @@
    transition_time = 0
 end

+-- Helper function to pre-load next image with proper cleanup
+local function preload_next_image()
+   if args.transition_duration > 0 then
+      -- Clean up old next_texture if it exists
+      if next_texture ~= nil then
+         rl.UnloadTexture(next_texture.texture)
+      end
+      collectgarbage()
+
+      -- Load next image (this may take time, but we do it early)
+      local success, result = pcall(image_handler.peek_next_image, image_handler)
+      if success then
+         next_texture = result
+      else
+         print("WARNING: Failed to pre-load next image: " .. tostring(result))
+         next_texture = nil
+      end
+   end
+end
+
+-- Pre-load the first next_texture at startup (during initial display time)
+preload_next_image()
+
 local function drawText()
    if args.display == "none" then
       return
@@ -106,6 +124,8 @@
       image_handler:increase_index()
       loaded_texture = image_handler:get_current_image()
       reset_timers()
+      -- Pre-load next image immediately to use full display time for loading
+      preload_next_image()
    end

    if rl.IsKeyPressed(rl.KEY_LEFT) then
@@ -113,12 +133,21 @@
       image_handler:decrease_index()
       loaded_texture = image_handler:get_current_image()
       reset_timers()
+      -- Pre-load next image immediately (preload_next_image handles cleanup)
+      preload_next_image()
    end

    if args.duration > 0 then
       if timer_duration >= args.duration then
-         transitioning = true
-         rl.SetTargetFPS(20)
+         -- Only transition if next image is ready (graceful fallback)
+         if args.transition_duration == 0 or next_texture ~= nil then
+            transitioning = true
+            rl.SetTargetFPS(20)
+         else
+            -- Next image not ready yet, extend display time
+            -- This prevents black screen - better to show current image longer
+            print("INFO: Next image not loaded yet, extending display time...")
+         end
       end
       timer_duration = timer_duration + rl.GetFrameTime()
    end
@@ -141,16 +170,24 @@

          image_handler:increase_index()
          loaded_texture = next_texture
+         -- CRITICAL: Clear next_texture reference before preload_next_image()
+         -- to prevent unloading the texture we just assigned to loaded_texture
+         next_texture = nil

-         next_texture = image_handler:peek_next_image()
          reset_timers()
+
+         -- Pre-load next image immediately to use full display time for loading
+         preload_next_image()
       end
    elseif transitioning then
+      -- No transition effect, just switch immediately
       rl.UnloadTexture(loaded_texture.texture)
       image_handler:increase_index()
       loaded_texture = image_handler:get_current_image()
       reset_timers()
       drawSingleImage()
+      -- Pre-load next image for next cycle
+      preload_next_image()
    elseif loaded_texture.image.kind == "animation" then
       rl.SetTargetFPS(math.floor(1000 / (loaded_texture.image).advance_frame()))
       rl.UpdateTexture(loaded_texture.texture, (loaded_texture.image).get_frame_pixels())
