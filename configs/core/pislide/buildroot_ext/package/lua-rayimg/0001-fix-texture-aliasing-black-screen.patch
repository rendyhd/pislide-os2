From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Wed, 26 Nov 2025 00:00:00 +0000
Subject: [PATCH] fix: Prevent black screen by breaking texture reference aliasing

Root Cause:
After a crossfade transition completes, `loaded_texture = next_texture` makes
both variables reference the same Lua table. When `preload_next_image()` is
called immediately after, it checks `if next_texture ~= nil` and unloads
`next_texture.texture` - but this is the SAME GPU texture that loaded_texture
is supposed to display, causing an immediate black screen for the entire
display duration until the next transition begins.

Solution:
Set `next_texture = nil` immediately after assigning it to `loaded_texture`,
before calling `preload_next_image()`. This breaks the aliasing so the
cleanup check in preload_next_image() correctly skips unloading.

---
 rayimg/build/rayimg/main.lua | 3 +++
 rayimg/src/rayimg/main.tl    | 3 +++
 2 files changed, 6 insertions(+)

diff --git a/rayimg/build/rayimg/main.lua b/rayimg/build/rayimg/main.lua
index 20aed62..a1b2c3d 100644
--- a/rayimg/build/rayimg/main.lua
+++ b/rayimg/build/rayimg/main.lua
@@ -169,6 +169,9 @@ while not rl.WindowShouldClose() do

          image_handler:increase_index()
          loaded_texture = next_texture
+         -- CRITICAL: Clear next_texture reference before preload_next_image()
+         -- to prevent unloading the texture we just assigned to loaded_texture
+         next_texture = nil

          reset_timers()

diff --git a/rayimg/src/rayimg/main.tl b/rayimg/src/rayimg/main.tl
index 8464458..b2c3d4e 100644
--- a/rayimg/src/rayimg/main.tl
+++ b/rayimg/src/rayimg/main.tl
@@ -170,6 +170,9 @@ while not rl.WindowShouldClose() do
             -- since the next image is already loaded, we just need to increase the index and move on
             image_handler:increase_index()
             loaded_texture = next_texture
+            -- CRITICAL: Clear next_texture reference before preload_next_image()
+            -- to prevent unloading the texture we just assigned to loaded_texture
+            next_texture = nil

             reset_timers()

